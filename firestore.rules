rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the current user is an admin
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // --- Rules for User Profiles/Roles ---
    match /users/{userId} {
      // Any authenticated user can read user profiles
      allow read: if request.auth != null;

      // A user can create their own profile, but cannot make themselves an admin
      allow create: if request.auth.uid == userId && request.resource.data.isAdmin == false;

      // Only admins can update user profiles (e.g., to grant admin status)
      allow update: if isAdmin();

      // Only admins can delete user profiles
      allow delete: if isAdmin();
    }
    
    // --- Rules for the SHARED Contacts Collection ---
    match /contacts/{contactId} {
      // All authenticated users can read the shared contacts
      allow read: if request.auth != null;
      
      // Only admins can create, update, or delete contacts in the shared list
      allow write: if isAdmin();
    }

    // --- (Optional) Rules for original individual contact lists ---
    // You can keep these if you still have data there, or remove them
    // if you have fully migrated to the shared 'contacts' collection.
    match /users/{userId}/contacts/{contactId} {
      allow read, write: if request.auth.uid == userId || isAdmin();
    }
  }
}